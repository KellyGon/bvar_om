# main cycle of estimation

# TODO: test left border for cv in lasso!


# torro may be installed via devtools::install_github("bdemeshev/torro")


library(torro)
library(tidyverse)
library(forecast)


missing <- c(37L, 45L, 81L, 169L, 175L, 222L, 224L, 664L, 674L, 757L, 762L, 
             797L, 940L, 986L, 1025L, 1032L, 1033L, 1118L, 1124L, 1125L, 1212L, 
             1215L, 1257L, 1305L, 1306L, 1307L, 1308L, 1309L, 1310L, 1311L, 
             1312L, 1313L, 1314L, 1315L, 1316L, 1317L, 1318L, 1319L, 1320L, 
             1321L, 1322L, 1323L, 1324L, 1325L, 1326L, 1327L, 1328L, 1329L, 
             1330L, 1331L, 1332L, 1333L, 1334L, 1335L, 1336L, 1337L, 1338L, 
             1339L, 1340L, 1341L, 1342L, 1343L, 1344L, 1345L, 1346L, 1347L, 
             1348L, 1349L, 1350L, 1351L, 1352L, 1353L, 1354L, 1355L, 1356L, 
             1357L, 1358L, 1359L, 1360L, 1361L, 1362L, 1363L, 1364L, 1365L, 
             1366L, 1367L, 1368L, 1369L, 1370L, 1371L, 1372L, 1373L, 1374L, 
             1375L, 1376L, 1377L, 1378L, 1379L, 1380L, 1381L, 1382L, 1383L, 
             1384L, 1385L, 1386L, 1387L, 1388L, 1389L, 1390L, 1391L, 1392L, 
             1393L, 1394L, 1395L, 1396L, 1397L, 1398L, 1399L, 1400L, 1401L, 
             1402L, 1403L, 1404L, 1405L, 1406L, 1407L, 1408L, 1409L, 1410L, 
             1411L, 1412L, 1413L, 1414L, 1415L, 1416L, 1417L, 1418L, 1419L, 
             1420L, 1421L, 1422L, 1423L, 1424L, 1425L, 1426L, 1427L, 1428L, 
             1429L, 1430L, 1431L, 1432L, 1433L, 1434L, 1435L, 1436L, 1437L, 
             1438L, 1439L, 1440L, 1441L, 1442L, 1443L, 1444L, 1445L, 1446L, 
             1447L, 1448L, 1449L, 1450L, 1451L, 1452L, 1453L, 1454L, 1455L, 
             1456L, 1457L, 1458L, 1459L, 1460L, 1461L, 1462L, 1463L, 1464L, 
             1465L, 1466L, 1467L, 1468L, 1469L, 1470L, 1471L, 1472L, 1473L, 
             1474L, 1475L, 1476L, 1477L, 1478L, 1479L, 1480L, 1481L, 1482L, 
             1483L, 1484L, 1485L, 1486L, 1487L, 1488L, 1489L, 1490L, 1491L, 
             1492L, 1493L, 1494L, 1495L, 1496L, 1497L, 1498L, 1499L, 1695L, 
             1696L, 1697L, 1698L, 1699L, 1700L, 1701L, 1702L, 1703L, 1704L, 
             1705L, 1706L, 1707L, 1708L, 1709L, 1710L, 1711L, 1712L, 1713L, 
             1714L, 1715L, 1716L, 1717L, 1718L, 1719L, 1720L, 1721L, 1722L, 
             1723L, 1724L, 1725L, 1726L, 1727L, 1728L, 1729L, 1730L, 1731L, 
             1732L, 1733L, 1734L, 1735L, 1736L, 1737L, 1738L, 1739L, 1740L, 
             1741L, 1742L, 1743L, 1744L, 1745L, 1746L, 1747L, 1748L, 1749L, 
             1750L, 1751L, 1752L, 1753L, 1754L, 1755L, 1756L, 1757L, 1758L, 
             1759L, 1760L, 1761L, 1762L, 1763L, 1764L, 1765L, 1766L, 1767L, 
             1768L, 1769L, 1770L, 1771L, 1772L, 1773L, 1774L, 1775L, 1776L, 
             1777L, 1778L, 1779L, 1780L, 1781L, 1782L, 1783L, 1784L, 1785L, 
             1786L, 1787L, 1788L, 1789L, 1790L, 1791L, 1792L, 1793L, 1794L, 
             1795L, 1796L, 1797L, 1798L, 1799L, 1800L, 2377L, 2378L, 2379L, 
             2380L, 2381L, 2382L, 2383L, 2384L, 2385L, 2386L, 2387L, 2388L, 
             2389L, 2390L, 2391L, 2392L, 2393L, 2394L, 2395L, 2396L, 2397L, 
             2398L, 2399L, 2400L, 2401L, 2402L, 2403L, 2404L, 2405L, 2406L, 
             2407L, 2408L, 2409L, 2410L, 2411L, 2412L, 2413L, 2414L, 2415L, 
             2416L, 2417L, 2418L, 2419L, 2420L, 2421L, 2422L, 2423L, 2424L, 
             2425L, 2426L, 2427L, 2428L, 2429L, 2430L, 2431L, 2432L, 2433L, 
             2434L, 2435L, 2436L, 2437L, 2438L, 2439L, 2440L, 2441L, 2442L, 
             2443L, 2444L, 2445L, 2446L, 2447L, 2448L, 2449L, 2450L, 2451L, 
             2452L, 2453L, 2454L, 2455L, 2456L, 2457L, 2458L, 2459L, 2460L, 
             2461L, 2462L, 2463L, 2464L, 2465L, 2466L, 2467L, 2468L, 2469L, 
             2470L, 2471L, 2472L, 2473L, 2474L, 2475L, 2476L, 2477L, 2478L, 
             2479L, 2480L, 2481L, 2482L, 2483L, 2484L, 2485L, 2486L, 2487L, 
             2488L, 2489L, 2490L, 2491L, 2492L, 2493L, 2494L, 2495L, 2496L, 
             2497L, 2498L, 2499L, 3600L, 3639L, 3640L, 3641L, 3642L, 3643L, 
             3644L, 3645L, 3646L, 3647L, 3648L, 3649L, 3650L, 3651L, 3652L, 
             3653L, 3654L, 3655L, 3656L, 3657L, 3658L, 3659L, 3660L, 3661L, 
             3662L, 3663L, 3664L, 3665L, 3666L, 3667L, 3668L, 3669L, 3670L, 
             3671L, 3672L, 3673L, 3674L, 3675L, 3676L, 3677L, 3678L, 3679L, 
             3680L, 3681L, 3682L, 3683L, 3684L, 3685L, 3686L, 3687L, 3688L, 
             3689L, 3690L, 3691L, 3692L, 3693L, 3694L, 3695L, 3696L, 3697L, 
             3698L, 3699L, 3700L, 3701L, 3702L, 3703L, 3704L, 3705L, 3706L, 
             3707L, 3708L, 3709L, 3710L, 3711L, 3712L, 3713L, 3714L, 3715L, 
             3716L, 3717L, 3718L, 3719L, 3720L, 3721L, 3722L, 3723L, 3724L, 
             3725L, 3726L, 3727L, 3728L, 3729L, 3730L, 3731L, 3732L, 3733L, 
             3734L, 3735L, 3736L, 3737L, 3738L, 3739L, 3740L, 3741L, 3742L, 
             3743L, 3744L, 3745L, 3746L, 3747L, 3748L, 3749L, 3750L, 3751L, 
             3752L, 3753L, 3754L, 3755L, 3756L, 3757L, 3758L, 3759L, 3760L, 
             3761L, 3762L, 3763L, 3764L, 3765L, 3766L, 3767L, 3768L, 3769L, 
             3770L, 3771L, 3772L, 3773L, 3774L, 3775L, 3776L, 3777L, 3778L, 
             3779L, 3780L, 3781L, 3782L, 3783L, 3784L, 3785L, 3786L, 3787L, 
             3788L, 3789L, 3790L, 3791L, 3792L, 3793L, 3794L, 3795L, 3796L, 
             3797L, 3798L, 3799L, 3800L, 3801L, 3802L, 3803L, 3804L, 3805L, 
             3806L, 3807L, 3808L, 3809L, 3810L, 3811L, 3812L, 3813L, 3814L, 
             3815L, 3816L, 3817L, 3818L, 3819L, 3820L, 3821L, 3822L, 3823L, 
             3824L, 3825L, 3826L, 3827L, 3828L, 3829L, 3830L, 3831L, 3832L, 
             3833L, 3834L, 3835L, 3836L, 3837L, 3838L, 3839L, 3840L, 3841L, 
             3842L, 3843L, 3844L, 3845L, 3846L, 3847L, 3848L, 3849L, 3850L, 
             3851L, 3852L, 3853L, 3854L, 3855L, 3856L, 3857L, 3858L, 3859L, 
             3860L, 3861L, 3862L, 3863L, 3864L, 3865L, 3866L, 3867L, 3868L, 
             3869L, 3870L, 3871L, 3872L, 3873L, 3874L, 3875L, 3876L, 3877L, 
             3878L, 3879L, 3880L, 3881L, 3882L, 3883L, 3884L, 3885L, 3886L, 
             3887L, 3888L, 3889L, 3890L, 3891L, 3892L, 3893L, 3894L, 3895L, 
             3896L, 3897L, 3898L, 3899L, 3900L, 3901L, 3902L, 3903L, 3904L, 
             3905L, 3906L, 3907L, 3908L, 3909L, 3910L, 3911L, 3912L, 3913L, 
             3914L, 3915L, 3916L, 3917L, 3918L, 3919L, 3920L, 3921L, 3922L, 
             3923L, 3924L, 3925L, 3926L, 3927L, 3928L, 3929L, 3930L, 3931L, 
             3932L, 3933L, 3934L, 3935L, 3936L, 3937L, 3938L, 3939L, 3940L, 
             3941L, 3942L, 3943L, 3944L, 3945L, 3946L, 3947L, 3948L, 3949L, 
             3950L, 3951L, 3952L, 3953L, 3954L, 3955L, 3956L, 3957L, 3958L, 
             3959L, 3960L, 3961L, 3962L, 3963L, 3964L, 3965L, 3966L, 3967L, 
             3968L, 3969L, 3970L, 3971L, 3972L, 3973L, 3974L, 3975L, 3976L, 
             3977L, 3978L, 3979L, 3980L, 3981L, 3982L, 3983L, 3984L, 3985L, 
             3986L, 3987L, 3988L, 3989L, 3990L, 3991L, 3992L, 3993L, 3994L, 
             3995L, 3996L, 3997L, 3998L, 3999L, 4644L, 4649L, 4663L, 4665L, 
             4668L, 4690L, 4720L, 4732L, 4741L, 4743L, 4746L, 4747L, 4755L, 
             4757L, 4759L, 4760L, 4761L, 4764L, 4773L, 4775L, 4783L, 4790L, 
             4794L, 4796L, 4816L, 4820L, 4822L, 4825L, 4829L, 4831L, 4835L, 
             4842L, 4848L, 4854L, 4860L, 4865L, 4867L, 4869L, 4872L, 4873L, 
             4878L, 4883L, 4885L, 4887L, 4889L, 4895L, 4901L, 4903L, 4910L, 
             4912L, 4914L, 4915L, 4921L, 4927L, 4930L, 4932L, 4933L, 4936L, 
             4944L, 4946L, 4954L, 4956L, 4958L, 4960L, 4962L, 4966L, 4967L, 
             4968L, 4975L, 4979L, 4980L, 4985L, 4987L, 4988L, 4990L, 4995L
)



basefolder <- "~/Documents/bvar_om/estimation/bvar_alternatives/"
n_cores <- 1
# 1 for non-parallel version
# max is equal to parallel::detectCores()
# but maybe non-optimal

# look at torro built-in data frames
# almost every data frame has "toy" little brother: shifts and shifts_toy etc
# glimpse(rus_macro)
# glimpse(shifts)
# glimpse(horizons)
# glimpse(var_sets)
# 
# glimpse(arguments_arima)
# glimpse(arguments_var_lasso)
# glimpse(arguments_var_lasso_toy)
# 
# 
# glimpse(models)


fits_long <- create_fits_long(shifts, models, var_sets, horizons)
# fits_long_toy <- create_fits_long(shifts_toy, models_toy, var_sets_toy, horizons_toy)


# readr::write_rds(fits_long, path = paste0(basefolder, "/fits_long.Rds"))



# forecasting

fits_long_subset <- fits_long[missing[1:300], ] # estimate on machine 1 for example

fits_long_2 <- forecast_all(fits_long_subset, var_sets, basefolder = basefolder,
                            n_cores = n_cores)


